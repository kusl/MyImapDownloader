name: Rolling Release

on:
  push:
    branches: [main, master, develop]

jobs:

  build-and-test:
    name: ${{ matrix.os }}
    runs-on: ${{ matrix.os }}
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'
          dotnet-quality: 'ga'
      
      - name: Display .NET info
        run: dotnet --info
      
      # Build entire solution (all projects)
      - name: Restore dependencies
        run: dotnet restore
      
      - name: Build solution
        run: dotnet build --no-restore --configuration Release
      
      # Run all tests across all test projects
      - name: Run tests
        run: dotnet test --no-build --configuration Release --verbosity normal
      
      - name: Upload test results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: test-results-${{ matrix.os }}
          path: '**/TestResults/**'
          retention-days: 7

  publish:
    name: Generate Rolling Release
    needs: build-and-test
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set Version String
        id: version
        # Format: YYYY.MM.DD.RUN_NUMBER
        run: echo "REL_VERSION=$(date +'%Y.%m.%d').${{ github.run_number }}" >> $GITHUB_OUTPUT

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: '10.0.x'

      - name: Publish Full-Fat Binaries
        run: |
          # Define runtimes - added osx-x64 for maximum compatibility
          for runtime in linux-x64 win-x64 osx-arm64 osx-x64; do
            echo "--- Processing $runtime ---"
            
            # 1. Build MyImapDownloader
            dotnet publish MyImapDownloader/MyImapDownloader.csproj -c Release -r $runtime \
              --self-contained true -p:PublishSingleFile=true -p:PublishTrimmed=false \
              -p:OutputExtensionsInBundle=true \
              -p:Version=${{ steps.version.outputs.REL_VERSION }} \
              -o ./dist/downloader-$runtime

            # 2. Build MyEmailSearch
            dotnet publish MyEmailSearch/MyEmailSearch.csproj -c Release -r $runtime \
              --self-contained true -p:PublishSingleFile=true -p:PublishTrimmed=false \
              -p:OutputExtensionsInBundle=true \
              -p:Version=${{ steps.version.outputs.REL_VERSION }} \
              -o ./dist/search-$runtime
            
            # 3. Zip with versioned filenames for the release page
            # This makes it easier for users to know exactly what they downloaded
            (cd ./dist/downloader-$runtime && zip -r ../../MyImapDownloader-$runtime-${{ steps.version.outputs.REL_VERSION }}.zip .)
            (cd ./dist/search-$runtime && zip -r ../../MyEmailSearch-$runtime-${{ steps.version.outputs.REL_VERSION }}.zip .)
          done

      - name: Create Rolling Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: rolling-build-${{ steps.version.outputs.REL_VERSION }}
          name: "Rolling Release: ${{ steps.version.outputs.REL_VERSION }}"
          body: |
            ### ðŸš€ Automated Rolling Release
            - **Version:** `${{ steps.version.outputs.REL_VERSION }}`
            - **Commit:** `${{ github.sha }}`
            - **Build Date:** $(date +'%Y-%m-%d %H:%M:%S')
            
            This is a full-fat production build. No .NET runtime installation is required on the target machine.
          files: |
            *.zip
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
