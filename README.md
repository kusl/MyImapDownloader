# MyImapDownloader

A high-performance, cross-platform command-line tool for archiving emails from IMAP servers. Built with .NET 10, featuring SQLite-backed indexing, intelligent delta syncing, and robust resilience patterns. 

---

*Notice: This project contains code generated by Large Language Models such as Claude and Gemini. All code is experimental.*

---

## Key Features

* **High-Performance Delta Sync**: Uses IMAP UIDs and a local SQLite index to only fetch new messages since the last successful run. 


* **Robust Storage & Deduplication**: Stores emails in standard `.eml` format with sidecar `.meta.json` files, indexed in SQLite for instant deduplication. 


* **Self-Healing Index**: Automatically detects database corruption and can rebuild the SQLite index from the existing `.meta.json` files on disk. 


* **Advanced Resilience**: Implements exponential backoff and circuit breaker patterns via Polly to handle flaky connections or server rate-limits. 


* **OpenTelemetry Native**: Full support for distributed tracing, metrics, and structured logging, exported to JSON Lines for easy analysis. 


* **Cross-Platform**: Natively supports Windows, Linux, and macOS. 



## Installation & Running

### Prerequisites

* [.NET 10 SDK](https://dotnet.microsoft.com/download/dotnet/10.0)

### Build & Run

```bash
git clone https://github.com/kusl/MyImapDownloader.git
cd MyImapDownloader
dotnet build -c Release
./MyImapDownloader/bin/Release/net10.0/MyImapDownloader -s imap.gmail.com -u user@gmail.com -p "password"

```

## Configuration

### Command-Line Options

| Option | Short | Default | Description |
| --- | --- | --- | --- |
| `--server` | `-s` | - | IMAP server address (e.g., `imap.gmail.com`) |
| `--username` | `-u` | - | Email account username |
| `--password` | `-p` | - | Account password or App Password |
| `--output` | `-o` | `EmailArchive` | Directory for archived emails and the SQLite index

 |
| `--all-folders` | `-a` | `false` | Sync all folders instead of just INBOX

 |
| `--start-date` | - | - | Filter: Download only after `yyyy-MM-dd`

 |
| `--end-date` | - | - | Filter: Download only before `yyyy-MM-dd`

 |

## Architecture & Storage

### Output Structure

The application now uses a hybrid storage approach:

* **Files**: Standard `.eml` files and `.meta.json` sidecars for maximum portability. 


* **Index**: An `index.v1.db` (SQLite) file resides in your output directory, tracking processed UIDs and Message-IDs to ensure 100% accuracy in deduplication even if you move files. 



### Delta Sync Strategy

1. **Checkpointing**: The app tracks the `UidValidity` and the last `HighestModSeq/UID` for every folder. 


2. **UID Search**: On subsequent runs, it only requests UIDs greater than the last successfully stored message. 


3. **Batch Processing**: Messages are processed in batches (default: 50) to minimize memory footprint and ensure progress is saved frequently. 



## Telemetry & Observability

The system generates rich telemetry in the `telemetry/` folder:

* **Traces**: Track the lifecycle of every email download and folder sync. 


* **Metrics**: Real-time counters for `storage.files.written`, `storage.bytes.written`, and histograms for `storage.write.latency`. 


* **Logs**: Correlated structured logs in JSON format. 



## License

Licensed under the **AGPL v3.0**. See the [LICENSE](https://www.google.com/search?q=LICENSE) file for details.





 please also rewrite this implementation summary 

 Below is a complete rewrite of your **Implementation Summary**. This updated version reflects the significant architectural shift toward a **SQLite-backed indexing system**, **Delta Sync logic**, and **enhanced OpenTelemetry instrumentation**.

---

# Implementation Summary: SQLite Indexing & Observability

This document summarizes the transition from a stateless file-system search to a persistent **SQLite-backed indexing system** and the integration of a comprehensive **OpenTelemetry** pipeline.

## 1. Core Architectural Changes

### High-Performance Delta Sync

* **UID Tracking**: The system now records `LastUid` and `UidValidity` for every folder in a local SQLite database (`index.v1.db`).


* **Targeted Fetching**: Subsequent runs perform a server-side search for UIDs strictly greater than the last successfully archived message, drastically reducing network overhead.


* **Batch Processing**: Downloads are executed in batches (50 messages) with checkpoints updated in the database after each successful batch.



### SQLite Message Index

* **Deduplication**: A `Messages` table serves as the primary index for `MessageId` values, allowing O(1) duplicate checks before attempting a network fetch.


* **Self-Healing Recovery**: If database corruption is detected, the system automatically relocates the corrupt file and rebuilds the entire SQLite index by scanning the `.meta.json` sidecar files on disk.


* **WAL Mode**: The database is configured with **Write-Ahead Logging (WAL)** to support better concurrency and resilience during high-throughput storage operations.



---

## 2. OpenTelemetry Implementation

The application now features a native OpenTelemetry provider that exports data to **JSON Lines (JSONL)** files for distributed tracing, metrics, and structured logging.

### New Telemetry Components

| File | Responsibility |
| --- | --- |
| `DiagnosticsConfig.cs` | Centralized `ActivitySource` and `Meter` definitions.

 |
| `JsonTelemetryFileWriter.cs` | Handles thread-safe, rotating file writes for JSON telemetry data.

 |
| `TelemetryExtensions.cs` | DI setup for registering OTel providers and local file exporters.

 |
| `ActivityExtension.cs` | Helper methods for enriching spans with exception data and tags.

 |

### Instrumentation Spans (Traces)

* **`EmailArchiveSession`**: The root span tracking the entire application lifecycle.


* **`DownloadEmails`**: Tracks the overall IMAP connection and folder enumeration.


* **`ProcessFolder`**: Captures delta sync calculations and batching logic per folder.


* **`SaveStream`**: High-resolution span covering the atomic write pattern, header parsing, and sidecar creation.


* **`RebuildIndex`**: Spans the recovery operation when reconstructing the database from disk.



### Key Performance Metrics

* **`storage.files.written`**: Counter for the total number of `.eml` files successfully archived.


* **`storage.bytes.written`**: Counter tracking the cumulative disk usage of archived messages.


* **`storage.write.latency`**: Histogram recording the total time (ms) spent on disk I/O and metadata serialization.



---

## 3. Storage & Reliability Patterns

### Atomic Write Pattern

To prevent partial file corruption, the `EmailStorageService` now implements a strict **TMP-to-CUR** move pattern:

1. Stream the network response directly to a `.tmp` file in the `tmp/` subdirectory.


2. Parse headers from the local file (using **MimeKit**) to generate the `.meta.json` sidecar.


3. Perform an atomic `File.Move` to the final `cur/` destination.



### Resilience via Polly

* **Retry Policy**: Exponential backoff (up to 5 minutes) handles transient network failures.


* **Circuit Breaker**: Automatically halts operations for 2 minutes if 5 consecutive authentication or connection failures occur to protect against account lockouts.



### Centralized Package Management

The project has moved to `Directory.Packages.props`, utilizing **Central Package Management (CPM)** to ensure version consistency across the main application and the new telemetry test suites.





