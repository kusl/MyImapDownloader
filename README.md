# MyImapDownloader

[![Build and Test](https://github.com/collabskus/MyImapDownloader/actions/workflows/ci.yml/badge.svg?branch=main)](https://github.com/collabskus/MyImapDownloader/actions/workflows/ci.yml)
[![.NET 10](https://img.shields.io/badge/.NET-10.0-512BD4?logo=dotnet)](https://dotnet.microsoft.com/)
[![License: AGPL v3](https://img.shields.io/badge/License-AGPL%20v3-blue.svg)](https://www.gnu.org/licenses/agpl-3.0)

A robust, cross-platform command-line tool for archiving emails from IMAP servers. Built with .NET 10, featuring comprehensive telemetry, intelligent deduplication, and resilient connection handling.

---

*Notice: This project contains code generated by Large Language Models such as Claude and Gemini. All code is experimental whether explicitly stated or not.*

---

## Features

- **Cross-Platform**: Runs on Windows, Linux, and macOS
- **IMAP Support**: Works with any IMAP-compatible email server (Gmail, Outlook, Yahoo, self-hosted, etc.)
- **Smart Deduplication**: Automatically detects and skips duplicate emails using Message-ID tracking
- **Maildir Storage**: Stores emails in a Maildir-inspired directory structure for easy access and portability
- **Date Filtering**: Download emails within specific date ranges
- **Folder Selection**: Archive all folders or just the inbox
- **Resilient Connections**: Built-in retry logic with exponential backoff and circuit breaker patterns using Polly
- **Comprehensive Telemetry**: OpenTelemetry-based tracing, metrics, and structured logging exported to JSON files
- **Progress Tracking**: Real-time progress updates during download

## Requirements

- [.NET 10 SDK](https://dotnet.microsoft.com/download/dotnet/10.0) or later

## Installation

### From Source

```bash
git clone https://github.com/collabskus/MyImapDownloader.git
cd MyImapDownloader
dotnet build --configuration Release
```

### Running

```bash
cd MyImapDownloader
dotnet run -- --server imap.example.com --username your@email.com --password yourpassword
```

Or run the compiled executable directly:

```bash
./MyImapDownloader --server imap.example.com --username your@email.com --password yourpassword
```

## Usage

### Basic Usage

```bash
MyImapDownloader --server imap.gmail.com --username your@gmail.com --password "your-app-password"
```

### Command-Line Options

| Option | Short | Required | Default | Description |
|--------|-------|----------|---------|-------------|
| `--server` | `-s` | Yes | - | IMAP server address |
| `--username` | `-u` | Yes | - | Email username |
| `--password` | `-p` | Yes | - | Email password or app password |
| `--port` | `-r` | No | 993 | IMAP port |
| `--output` | `-o` | No | `EmailArchive` | Output directory for archived emails |
| `--start-date` | - | No | - | Download emails from this date (yyyy-MM-dd) |
| `--end-date` | - | No | - | Download emails until this date (yyyy-MM-dd) |
| `--all-folders` | `-a` | No | false | Download from all folders, not just INBOX |
| `--verbose` | `-v` | No | false | Enable verbose logging |

### Examples

**Download all emails from inbox:**
```bash
MyImapDownloader -s imap.gmail.com -u user@gmail.com -p "app-password" -o ./backup
```

**Download emails from all folders within a date range:**
```bash
MyImapDownloader -s imap.gmail.com -u user@gmail.com -p "app-password" \
    --all-folders --start-date 2024-01-01 --end-date 2024-12-31
```

**Verbose output with custom port:**
```bash
MyImapDownloader -s mail.example.com -u user@example.com -p "password" \
    --port 143 --verbose
```

### Gmail Configuration

For Gmail, you'll need to:

1. Enable 2-Factor Authentication on your Google account
2. Generate an App Password at [Google Account Security](https://myaccount.google.com/apppasswords)
3. Use `imap.gmail.com` as the server with port 993

## Output Structure

Downloaded emails are stored in a Maildir-inspired structure:

```
EmailArchive/
├── INBOX/
│   ├── 2024-01-15_143052_abc123def456.eml
│   ├── 2024-01-15_143055_xyz789ghi012.eml
│   └── ...
├── Sent/
│   └── ...
├── Drafts/
│   └── ...
├── .email-index.json          # Deduplication index
└── telemetry/                 # Telemetry data
    ├── traces.jsonl
    ├── metrics.jsonl
    └── logs.jsonl
```

Each `.eml` file is a standard RFC 5322 email message that can be opened with any email client.

## Telemetry

MyImapDownloader includes comprehensive telemetry powered by OpenTelemetry:

- **Traces**: Distributed tracing for all operations (connections, folder processing, email downloads)
- **Metrics**: Counters and histograms for emails downloaded, skipped, errors, bytes transferred, latencies
- **Logs**: Structured JSON logging with correlation to traces

Telemetry is exported to JSON Lines files in the `telemetry/` directory by default.

### Configuration

Telemetry can be configured via `appsettings.json`:

```json
{
  "Telemetry": {
    "ServiceName": "MyImapDownloader",
    "ServiceVersion": "1.0.0",
    "OutputDirectory": "telemetry",
    "MaxFileSizeMB": 25,
    "EnableTracing": true,
    "EnableMetrics": true,
    "EnableLogging": true,
    "FlushIntervalSeconds": 5,
    "MetricsExportIntervalSeconds": 15
  }
}
```

## Building

```bash
# Restore dependencies
dotnet restore

# Build debug
dotnet build

# Build release
dotnet build --configuration Release

# Run tests
dotnet test

# Publish self-contained executable
dotnet publish -c Release -r win-x64 --self-contained
dotnet publish -c Release -r linux-x64 --self-contained
dotnet publish -c Release -r osx-x64 --self-contained
```

## Architecture

The application is built with clean separation of concerns:

- **Program.cs**: Application entry point and dependency injection setup
- **EmailDownloadService**: Core IMAP download logic with retry policies
- **EmailStorageService**: File storage with deduplication
- **DownloadOptions**: Command-line argument parsing
- **ImapConfiguration**: IMAP connection settings
- **Telemetry/**: OpenTelemetry exporters and configuration

### Key Dependencies

- [MailKit](https://github.com/jstedfast/MailKit) - IMAP client library
- [Polly](https://github.com/App-vNext/Polly) - Resilience and transient fault handling
- [CommandLineParser](https://github.com/commandlineparser/commandline) - CLI argument parsing
- [OpenTelemetry](https://opentelemetry.io/) - Observability framework
- [Microsoft.Extensions.Hosting](https://docs.microsoft.com/en-us/dotnet/core/extensions/generic-host) - Application hosting

## Contributing

Contributions are welcome! Please feel free to submit issues and pull requests.

1. Fork the repository
2. Create your feature branch (`git checkout -b feature/amazing-feature`)
3. Commit your changes (`git commit -m 'Add some amazing feature'`)
4. Push to the branch (`git push origin feature/amazing-feature`)
5. Open a Pull Request

## License

This project is licensed under the GNU Affero General Public License v3.0 - see the [LICENSE](LICENSE) file for details.

### AGPL-3.0 Summary

- ✅ You can use, modify, and distribute this software
- ✅ You can use it for commercial purposes
- ⚠️ You must disclose the source code of any modifications
- ⚠️ If you run a modified version on a server, you must make the source available to users
- ⚠️ You must license derivatives under AGPL-3.0
- ⚠️ You must include the original copyright and license notices

## Acknowledgments

- [MailKit](https://github.com/jstedfast/MailKit) for the excellent IMAP library
- The .NET team for the fantastic framework
- Contributors to all the open-source libraries used in this project
